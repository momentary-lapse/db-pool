name: Run Tests
on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
          image: postgres
          env:
              POSTGRES_PASSWORD: postgres
          options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
          ports:
              - 5432:5432
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup MariaDB
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: mariadb-11.1
          root-password: root
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Run Tests
        run: |
          echo "MYSQL_USERNAME=root" > .env
          echo "MYSQL_PASSWORD=root" >> .env
          echo "MYSQL_HOST=127.0.0.1" >> .env
          cargo test --all-features
